<div class="box" style="border-radius:1rem;">
  <div class="is-flex is-justify-content-space-between is-align-items-center mb-3">
    <div class="is-size-6 has-text-weight-semibold">Requests per minute</div>
    <div class="is-size-7 has-text-grey">AI percentage highlighted</div>
  </div>

  <!-- sized parent: makes layout stable -->
  <div id="netChartWrap-{{ id }}" style="position:relative; width:100%; height:280px;">
    <canvas id="netChart-{{ id }}"></canvas>
  </div>
</div>

<script>
(function() {
  const cid = "netChart-{{ id }}";
  const key = "__chartInst_" + cid;

  // if HTMX reloaded this fragment, destroy the old chart to avoid stacking/reflow
  if (window[key]) {
    try { window[key].destroy(); } catch(_) {}
    window[key] = null;
  }

  fetch("/admin/submissions/{{ id }}/net_timeline.json")
    .then(r => r.json())
    .then(data => {
      const ctx = document.getElementById(cid).getContext("2d");

      const labels = data.map(p => p.t);
      const ai = data.map(p => p.ai);
      const other = data.map(p => Math.max(0, p.total - p.ai));
      const ma100 = data.map(p => p.ma100);

      window[key] = new Chart(ctx, {
        type: "bar",
        data: {
          labels,
          datasets: [
            { label: "AI", data: ai, stack: "req", borderWidth: 0 },
            { label: "Other", data: other, stack: "req", borderWidth: 0 },
            { label: "MA(100)", data: ma100, type: "line", yAxisID: "y", tension: 0.2, pointRadius: 0 }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,          // allow the parent height to control the chart
          interaction: { mode: "index", intersect: false },
          plugins: {
            legend: { position: "top" },
            tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${Math.round(ctx.parsed.y)}` } }
          },
          scales: {
            x: { stacked: true, ticks: { maxRotation: 0, autoSkip: true } },
            y: { stacked: true, beginAtZero: true }
          }
        }
      });
    })
    .catch(err => console.error("timeline fetch error", err));
})();
</script>
