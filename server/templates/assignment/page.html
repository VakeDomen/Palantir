<!doctype html>
<html>

<head>
  {% include "partials/head_include.html" %}
  <title>Assignment {{ assignment_id }}</title>
</head>

<body>
  {% include "partials/navbar.html" %}

  <section class="section">
    <div class="container">
      <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
          <li><a href="/admin">Dashboard</a></li>
          <li class="is-active"><a aria-current="page">Assignment {{ assignment_id }}</a></li>
        </ul>
      </nav>


      <div class="columns is-multiline box">
        <!-- <div class="column is-6" hx-get="/admin/assignment/{{ assignment_id }}/stats_activity" hx-trigger="load"
          hx-swap="innerHTML">
          <div class="box">Loading activity…</div>
        </div> -->

        <!-- <div class="column is-6" hx-get="/admin/assignment/{{ assignment_id }}/stats_status" hx-trigger="load"
          hx-swap="innerHTML">
          <div class="box">Loading status…</div>
        </div> -->

        <div hx-get="/admin/assignment/{{ assignment_id }}/stats_duration" hx-trigger="load" hx-swap="outerHTML">
          <div class="box">Loading duration…</div>
        </div>

        <div hx-get="/admin/assignment/{{ assignment_id }}/stats_browser" hx-trigger="load" hx-swap="outerHTML">
          <div class="box">Loading browsers…</div>
        </div>

        <!-- <div hx-get="/admin/assignment/{{ assignment_id }}/stats_domains" hx-trigger="load" hx-swap="outerHTML">
          <div class="box">Loading domains…</div>
        </div> -->

        <div hx-get="/admin/assignment/{{ assignment_id }}/stats_outliers" hx-trigger="load" hx-swap="outerHTML">
          <div class="box">Scanning for outliers…</div>
        </div>

        <div hx-get="/admin/assignment/{{ assignment_id }}/stats_shared_lan" hx-trigger="load" hx-swap="outerHTML">
          <div class="box">Checking shared local IPs…</div>
        </div>
      </div>


      <div class="box mb-4">
        <form id="assign-controls" hx-get="/admin/assignment/{{ assignment_id }}/table_rows"
          hx-target="#submissions-table-body" hx-swap="innerHTML" hx-boost="false">

          <div class="columns is-vcentered is-multiline">
            <!-- Left: student search -->
            <div class="column is-6">
              <div class="field">
                <label class="label is-size-7 mb-1">Search student</label>
                <div class="control">
                  <input class="input" type="text" name="q" placeholder="e.g. alice" hx-trigger="keyup changed"
                    hx-get="/admin/assignment/{{ assignment_id }}/table_rows" hx-target="#submissions-table-body"
                    hx-swap="innerHTML" hx-include="#assign-controls">
                </div>
              </div>
            </div>

            <!-- Right: add rule -->
            <div class="column is-6">
              <label class="label is-size-7 mb-1">Add rule</label>
              <div class="field has-addons">
                <p class="control">
                  <span class="select">
                    <select id="rule-key">
                    {% for k in allowed_keys_num %}
                      <option value="{{ k }}">{{ k }}</option>
                    {% endfor %}
                    {% for k in allowed_keys_bool %}
                      <option value="{{ k }}">{{ k }}</option>
                    {% endfor %}
                  </select>
                  </span>
                </p>
                <p class="control">
                  <span class="select">
                    <select id="rule-op">
                      <option value="gt">&gt;</option>
                      <option value="ge">&ge;</option>
                      <option value="eq">=</option>
                      <option value="le">&le;</option>
                      <option value="lt">&lt;</option>
                      <option value="ne">≠</option>
                      <option value="exists">exists</option>
                    </select>
                  </span>
                </p>
                <p class="control is-expanded">
                  <input class="input" id="rule-val" placeholder="value (true/false or number)">
                </p>
                <p class="control">
                  <button class="button" type="button" id="add-rule">Add</button>
                </p>
              </div>

              <!-- Where active rules live (as hidden inputs + tags) -->
            </div>
            <div id="active-rules" class="column is-12 tags mt-2"></div>
          </div>
        </form>



        <div class="table-container">
          <table class="table is-fullwidth is-hoverable is-striped">
            <thead>
              <tr>
                <th class="nowrap">Student</th>
                <th class="nowrap">Submitted</th>
                <th class="nowrap">Tags</th>
                <th class="has-text-right"></th>
              </tr>
            </thead>
            <tbody id="submissions-table-body" hx-get="/admin/assignment/{{ assignment_id }}/table_rows"
              hx-trigger="load" hx-target="#submissions-table-body" hx-swap="innerHTML">
            </tbody>
            </tbody>
          </table>
        </div>
      </div>

    </div>
  </section>
</body>

</html>


<script>
  (function () {
    const rulesEl = document.getElementById('active-rules');
    const form = document.getElementById('assign-controls');
    const keyEl = document.getElementById('rule-key');
    const opEl = document.getElementById('rule-op');
    const valEl = document.getElementById('rule-val');

    function addRuleChip(key, op, val) {
      const id = crypto.randomUUID();

      // visible chip
      const chip = document.createElement('span');
      chip.className = 'tag ml-2';
      chip.dataset.ruleId = id;
      chip.textContent = op === 'exists' ? `${key} exists ` : `${key} ${op} ${val} `;
      const del = document.createElement('button');
      del.type = 'button';
      del.className = 'delete is-small';
      del.onclick = () => {
        form.querySelectorAll(`input[data-rule-id="${id}"]`).forEach(n => n.remove());
        chip.remove();
        htmx.trigger(form, 'submit');
      };
      chip.appendChild(del);
      rulesEl.appendChild(chip);

      // hidden input with the whole JSON
      const inp = document.createElement('input');
      inp.type = 'hidden';
      inp.name = 'filters[]';
      inp.value = JSON.stringify({ key, op, val });
      inp.dataset.ruleId = id;
      form.appendChild(inp);

      htmx.trigger(form, 'submit');
    }


    // Adapt value input type for booleans
    keyEl.addEventListener('change', () => {
      const k = keyEl.value;
      if (k === 'had_browser') { valEl.placeholder = 'true or false'; }
      else { valEl.placeholder = 'value (number)'; }
    });

    document.getElementById('add-rule').addEventListener('click', () => {
      const key = keyEl.value;
      const op = opEl.value;
      let val = valEl.value.trim();
      if (op !== 'exists' && val === '') return;
      if (key === 'had_browser' && op !== 'exists') {
        const t = val.toLowerCase();
        if (t !== 'true' && t !== 'false') { alert('Use true/false for had_browser'); return; }
      }
      addRuleChip(key, op, val);
      valEl.value = '';
      htmx.trigger(form, 'submit');
    });
  })();
</script>